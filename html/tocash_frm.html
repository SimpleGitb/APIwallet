<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>title</title>
      <link rel="stylesheet" type="text/css" href="../css/api.css"/>
      <style>
          .blank{ height: .1rem; background: #F9F9F9;}
          .adress{ font-size:.16rem; color:#2A3145; margin:.2rem 0 0 .15rem; }
          .ethadress{ height:.47rem; }
          input{ font-size: .14rem;width: 3.6rem; height: .2rem;line-height: .2rem;outline: none; position: absolute; left:.15rem; margin-top: .15rem;}
          .blank_3{ height: 1px; background:#F9F9F9; width: 93%; margin: auto;}
          .btn{font-size:.18rem; margin: .3rem .15rem;height: .45rem; line-height: .45rem; text-align: center; background: #376AFC;  color: #fff;  border-radius: .06rem;}
          .title{ font-size:.16rem; color: #2A3145; margin: .2rem 0 0 .15rem; margin-bottom: .1rem;}
          .row{ height: .75rem;font-size: .12rem; color: #BEBEBE;}
          .row_t{ font-size:.15rem; color: #50D26F; padding: .2rem 0 0 .15rem; display: flex; justify-content: space-between;}
          .row_r{ font-size:.2rem; color: #50D26F;margin-right: .15rem;}
          .row_b{ display: flex; justify-content: space-between; margin:.08rem .15rem .17rem .15rem; }
          .blank_2{ height: 1px; background:#F9F9F9; width: 96%; margin-left: 4%;}
          .color1{
            color: #FF5656 !important;
          }
          .color2{
            color: #50D26F !important;
          }
          .row_l{
            color: #2D3143;
          }
          .nodata{
            width: 100%;
            height: 4rem;
            text-align: center;
          }
          .nodata img{
            width: 0.6rem;
            height: .72rem;
            margin-top: 2rem;
          }
          .nomessage{
            font-size: .15rem;
            color: #BEBEBE;
          }
          .truthful{
            font-size: .16rem;
            color: red;
            margin-left: .15rem;
            display: none;
          }
      </style>
  </head>
  <body>
    <div class="wrap">
      <div class="blank"></div>
      <div class="wrap_top">
        <div class="adress">MYAI提现地址:</div>
        <div class="ethadress"><input type="text" id="CashAddress" placeholder="请输入MYAI提现地址" autofocus="autofocus"/></div>
        <div class="blank_3"></div>
        <div class="adress">请输入您的提现数量（当前手续费 <span id="handfee">0%</span>）</div>
        <div class="ethadress"><input type="tel" autofocus="autofocus" id="tocashnum" placeholder="请输入您的提现数量" onkeyup="feeChange()"></div>
        <div class="blank_3"></div>
        <div class="ethadress truthful">实际到账<span id="truecash"></span>，手续费<span id="feecash"></span></div>
        <div class="btn" onclick="toCash()">确认提现</div>
      </div>
      <div class="blank"></div>
      <div class="wrap_b" >
        <div class="title">提现记录</div>
        <div id="tocash" id="tocash">

        </div>
      </div>
    </div>
  </body>
  <script type='text/template' id='tocashTmpl'>
    {{if( it && it.length>0){ }}
    {{ for(let k in it) { }}
      {{if( it[k].payType =='04'){ }}
        <div class="row">
          <div class="row_t">
            <span class="row_l">提现</span>
            {{if( it[k].inOrOut =='01'){ }}
            <span class="row_r color1">+{{=it[k].amount}}</span>
            {{ }else{ }}
            <span class="row_r color2">-{{=it[k].amount}}</span>
            {{ } }}
          </div>
          <div class="row_b">
            <span>{{= it[k].updateTime}}</span>
            <span>MYAI</span>
          </div>
        </div>
        <div class="blank_2"></div>
      {{ } }}

    {{ } }}
    {{ }else{ }}
      <div class="nodata">
        <img src="../image/no_data.png" alt="">
        <div class="nomessage">暂无记录</div>
      </div>
    {{ } }}
  </script>
  <script type="text/javascript" src="../script/api.js"></script>
  <script type="text/javascript" src="../script/common.js"></script>
  <script type="text/javascript" src="../script/zepto.min.js"></script>
  <script type="text/javascript" src="../script/doT.min.js"></script>
  <script type="text/javascript" src="../script/aes.js"></script>
  <script type="text/javascript">
      // let buypwd = $api.getStorage('password');
      var feeData;
      apiready = function(){
        userInfo = $api.getStorage('userInfo');
        postRequest('getTransactionRecordList',{accessToken: userInfo.token,},function(ret) {
          if(ret.flag ==true && ret){
            console.log(JSON.stringify(ret.data))
            let tocashTmpl = doT.template($api.byId('tocashTmpl').innerHTML);
            $api.byId('tocash').innerHTML = tocashTmpl(ret.data.rows);
          }
        })
        postRequest('getTradeFee',{accessToken: userInfo.token,currency:'MYAI'},function(ret) {
          if(ret.flag ==true && ret){
            console.log(JSON.stringify(ret.data))
            $api.byId('handfee').innerHTML = ret.data*100+"%";
            feeData = ret.data;
          }
        })
      };
      function toCash(){
        if(!$api.val($api.dom('#CashAddress'))){
          api.toast({msg:'请输入MYAI提现地址'});
          return;
        }
        if(!$api.val($api.dom('#tocashnum'))){
          api.toast({msg:'请输入您的提现数量'});
          return;
        }
        postRequest('exitsPassword',{accessToken:userInfo.token},function(ret) {
          if(ret.data == true){
            paymethod()
          }else {
            api.confirm({
                title: '提示',
                msg: '未设置资金密码，是否去设置？',
                buttons: ['确定', '取消']
            }, function(ret, err) {
                // var index = ret.buttonIndex;i
                if(ret.buttonIndex=="1"){
                  api.openWin({
                      name: 'funds_win',
                      url: './funds_win.html'
                  });
                }else {
                  api.toast({msg: '未设置资金密码无法提现',});
                }
            });
          }
        })
    }
    function paymethod(){
      $('body').on('touchend', function(el) {
        if(el.target.tagName != 'INPUT') {
          $('input').blur()
        }
      })
      setTimeout(function(){
        api.openFrame({
            name: 'pwd3',
            url: './pwd3.html',
            rect: {
                x: 0,
                y: 0,
                w: api.winWidth,
                h: api.winHeight,
            },
            bounces: false,
            bgColor: 'rgba(255,255,255,.2)',
        });
      },200);
    }
    function payCallback(pwd){
      // console.log(String(pwd));
          postRequest('getAeskey',{accessToken:userInfo.token},function (ret) {
            if(ret.flag == true){
              key =ret.data;
              var keyval = CryptoJS.enc.Utf8.parse(key);
              var plaintText = String(pwd);
              var iv   = CryptoJS.enc.Latin1.parse('ed16b1f8a9e648d4');
              var encryptedData = CryptoJS.AES.encrypt(plaintText, keyval, {
                  iv:iv,
                  mode: CryptoJS.mode.CBC,
                  padding: CryptoJS.pad.Pkcs7
              });
              enced = CryptoJS.enc.Base64.stringify(encryptedData.ciphertext);
              postRequest('trade',{fromAccount:userInfo.address,
                  toAccount: $api.val($api.dom('#CashAddress')),
                  money: $api.val($api.dom('#tocashnum')),
                  currecy:'MYAI',
                  password:enced,
                  accessToken:userInfo.token},
                  function(ret){
                    console.log(JSON.stringify(ret))
                  if(ret.flag ==true){
                    api.toast({ msg: '提现成功' }); 
                    api.sendEvent({
                        name: 'update',
                    });
                  }else {
                    api.toast({ msg: ret.errMsg }); 
                  }
              })
            }
          })
    }
    function feeChange(){
      var truecash,feecash;
      var tocashnum = $api.val($api.dom('#tocashnum'));
      if(tocashnum){
        $api.css($api.dom('.truthful'),'display:block');
      }else {
        $api.css($api.dom('.truthful'),'display:none');
      }
      if(Number(tocashnum)){
        feecash = tocashnum * feeData;
        truecash = tocashnum - feecash;
        $api.byId('truecash').innerHTML = truecash;
        $api.byId('feecash').innerHTML = feecash;
      }
    }
  </script>
  </html>
