<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>忘记密码</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
</head>

<body>
    <div id="formList" class="flex-wrap flex-vertical">
        <div id="header">
            <div class="event-back"></div>
        </div>
        <h3>忘记密码</h3>
        <div class="form_box">
            <div class="input-t">
                <label>您的帐号（邮箱）</label>
                <input type="text" placeholder="请输入您的邮箱" id="email">
                <div class="clear" tapmode onClick="fnClearInput(this)"></div>
            </div>
            <div class="input-t">
                <label>验证码</label>
                <input type="text" placeholder="请输入验证码" id="code">
                <div class="code" id="sendCode">发送验证码</div>
            </div>
            <div class="input-t">
                <label>新密码</label>
                <input type="password" placeholder="请输入新密码" id="password1">
                <div class="clear" tapmode onClick="fnClearInput(this)"></div>
            </div>
            <div class="input-t">
                <label>确认密码</label>
                <input type="password" placeholder="再次输入密码" id="password2">
                <div class="clear" tapmode onClick="fnClearInput(this)"></div>
            </div>
            <div class="btn" tapmode onclick="fnSubmit()">下一步</div>
        </div>
    </div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/gt.js"></script>
<script type="text/javascript">
      var demo;
      apiready = function() {
        fnReady()
      };

      function fnSubmit(){

        let list = [$api.val($api.byId('email')),$api.val($api.byId('code')),$api.val($api.byId('password1')),$api.val($api.byId('password2'))];
        let params = {
          code: list[1],
          type:2,
          address:list[0],
        };
        let Email = /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
        if(params.address == ''){
          api.toast({msg: '请输入您的邮箱',});
          return;
        }
        if(!Email.test(params.address)){
          api.toast({msg: '邮箱格式不正确',});
          return;
        }
        if(params.code == ''){
          api.toast({msg: '请输入验证码',});
          return;
        }
        if(list[2] == ''){
          api.toast({msg: '请输入新密码',});
          return;
        }
        if(list[3] == ''){
          api.toast({msg: '请再次输入新密码',});
          return;
        }
        if(list[2] !== list[3]){
          api.toast({msg: '俩次输入的密码不一致',});
          return;
        }
        getRequest('setLoginPassword','&loginPassword='+list[2]+'&type=2&address='+list[0]+'&code='+list[1],function(ret) {
            api.closeWin();
        })
      };

      //获取验证码
      let wait = 60
      function time(dom) {
      	if (wait == 0) {
      	  dom.removeClass('readonly');
      	  dom.text("发送验证码");
      	  wait = 60;
      	} else {
      	  dom.addClass('readonly');
      	  dom.text( wait + "重新发送");
      	  wait--;
      	  setTimeout(function() {
      		  time(dom)
      	  }, 1000);
      	}
      }

      function sendCode(thisB) {
        let thisBtn = $(thisB);
        let address = $api.val($api.byId('email'))
        let Email = /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
        if(address == ''){
          api.toast({msg: '请输入您的邮箱',});
          return;
        }
        if(!Email.test(address)){
          api.toast({msg: '邮箱格式不正确',});
          return;
        }
        if(wait == 60){
          postRequest('getRegisterCode',{
            address: address,
            type:'2'
          },function(ret){
              if(ret.flag === true){
                time(thisBtn);
              }else{
                api.toast({msg: ret.errMsg});
              }
          })
        }
      }
      $(function(){
          $('input').focus(function(){
            $(this).parent().siblings().find('.clear').hide();
            $(this).parent().find('.clear').show();
          })
      })
      var handler = function (captchaObj) {
          captchaObj.onReady(function () {
              $("#wait").hide();
          }).onSuccess(function () {
              var result = captchaObj.getValidate();
              if (!result) {
                  return alert('请完成验证');
              }
              if(wait == 60){
                // console.log(JSON.stringify(result))
                postRequest('getRegisterCode',{
                  address: $api.val($api.byId('email')),
                  type:'2',
                  geetest_challenge:result.geetest_challenge,
                  geetest_validate:result.geetest_validate,
                  geetest_seccode:result.geetest_seccode
                },function(ret){
                  console.log(JSON.stringify(ret))
                    if(ret.flag === true){
                      time($('#sendCode'));
                    }else{
                      api.toast({msg: ret.errMsg});
                    }
                })
              }
          });
          $('#sendCode').click(function () {
            let address = $api.val($api.byId('email'))
            let Email = /^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
            if(address == ''){
              api.toast({msg: '请输入您的邮箱'});
              return ;
            }
            if(!Email.test(address)){
              api.toast({msg: '邮箱格式不正确'})
              return ;
            }
            if(wait == 60){
              captchaObj.verify();
            }
          })
          // 更多前端接口说明请参见：http://docs.geetest.com/install/client/web-front/
      };
      $.ajax({
          url: "http://36.33.216.16:28080/app-rest/verification?t=" + (new Date()).getTime(), // 加随机数防止缓存
          type: "post",
          dataType: "json",
          data:{
            phone:$api.val($api.byId('email'))
          },
          success: function (data) {
              // 调用 initGeetest 进行初始化
              // 参数1：配置参数
              // 参数2：回调，回调的第一个参数验证码对象，之后可以使用它调用相应的接口
              initGeetest({
                  // 以下 4 个配置参数为必须，不能缺少
                  gt: data.gt,
                  challenge: data.challenge,
                  offline: !data.success, // 表示用户后台检测极验服务器是否宕机
                  new_captcha: data.new_captcha, // 用于宕机时表示是新验证码的宕机
                  timeout: '5000',
                  product: "bind", // 产品形式，包括：float，popup
                  width: "300px",
                  https: true

                  // 更多前端配置参数说明请参见：http://docs.geetest.com/install/client/web-front/
              }, handler);
          }
      });
</script>

</html>
