<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <style>
        * {
            margin: 0;
            padding: 0
        }

        html {
            background: #f5f5f5;
        }

        body {
            background: none;
        }

        .wrap {
            display: flex;
            flex-direction: column;
            margin-top: .1rem;
        }

        .wrap_top {
            height: 2.12rem;
            background: #fff;
        }

        .message {
            font-size: .16rem;
            height: .16rem;
            margin: .2rem 0 .2rem .15rem;
        }

        .blank {
            height: .01rem;
            background: #f6f6f6;
            margin: 0 .15rem;
        }

        .row {
            font-size: .14rem;
            display: flex;
            justify-content: space-between;
        }

        .row_l {
            height: .14rem;
            color: #888888;
            margin: .15rem 0 0 .15rem;
        }

        .row_l2 {
            margin-top: .2rem;
        }

        .row_r {
            margin: .15rem .15rem 0 0;
            height: .14rem;
            text-align: right;
        }

        .row_r2 {
            margin-top: .18rem;
        }

        .wrap_bottom {
            height: 1.37rem;
            background: #ffffff;
            margin-top: .1rem;
        }

        .wrap_bottom_t {
            font-size: .16rem;
            margin: .19rem 0 .19rem .15rem;
        }

        .wrap_bottom_b {
            font-size: .14rem;
            margin: .19rem .15rem .19rem .15rem;
        }

        .wrap_bottom_b_t {
            margin: .19rem 0 .14rem 0;
        }

        .wrap_bottom_b_b {
            display: flex;
            justify-content: space-between;
        }

        .top{
          display: flex;
          flex-direction: row;
        }

        .right{
          margin-left: .05rem;
        }

        .wrap_bottom_l {
            color: #888888;
        }

        .wrap_bottom_r {
            color: #000000;
        }

        .swich {
            width: .36rem;
            height: .17rem;
        }

        .swich .box {
            width: .36rem;
            height: .17rem;
            display: flex;
            align-items: center;
            background: #ccc;
            border-radius: 20px;
            transition: all .5s ease;
        }

        .swich input {
            display: none;
        }

        .swich .box span {
            display: inline-block;
            height: .13rem;
            width: .13rem;
            border-radius: 15px;
            background: #fff;
            transform: translateX(0px);
            transition: all .5s ease;
        }

        .swich-on .box {
            background: #FF4F00;
            transition: all .5s ease;
        }

        .swich-on .box span {
            transform: translateX(22px);
            transition: all .5s ease;
        }

        .wrap_footer {
            height: 1.24rem;
            margin: .1rem 0 0 0;
            background: #fff;
        }

        .wrap_footer_t {
            font-size: .16rem;
            margin: .19rem 0 .19rem .15rem;
        }

        .wrap_footer_b {
            font-size: .14rem;
            width: 1.43rem;
            height: .28rem;
            line-height: .3rem;
            color: #376AFC;
            text-align: center;
            border: 1px solid #376AFC;
            border-radius: .06rem;
            margin: .19rem 0 0 .15rem;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            background: #fff;
            display: flex;
            justify-content: space-between;
            width: 100%;
            height: .5rem;
        }

        .footer_left {
            font-size: .14rem;
            height: .16rem;
            line-height: .16rem;
            color: #2A3145;
            margin: .17rem 0 .17rem .15rem;
        }

        .footer_r {
            color: #FF4F00;
        }
        .footer_ra{
          color: #FF4F00;
        }
        .footer_right {
            font-size: .18rem;
            width: 1.54rem;
            height: .5rem;
            line-height: .5rem;
            text-align: center;
            background: #FF4F00;
            color: #ffffff;
        }

        .wrap_footer_r {
            color: #FF4F00;
        }
        #emalicontent{
          color:#2A3145;font-size:14px;margin-left:30px
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="wrap_top">
            <div class="message">确认信息</div>
            <div class="blank"></div>
            <div onclick="selectScroll()" id="payScroll">

            </div>
        </div>
        <div class="wrap_bottom">
            <div class="wrap_bottom_t">付款信息</div>
            <div class="blank"></div>
            <div class="wrap_bottom_b">
                <div id="pay_info"></div>
            </div>
        </div>
        <div class="wrap_footer">
            <div class="wrap_footer_t">选择用户</div>
            <div class="blank"></div>
            <div onclick="choiceUser()" id="emalicontent" style="line-height:0.67rem"> 点击选择我的用户</div>
            <!-- <div class="wrap_footer_b" onclick="choiceUser()">点击选择我的用户</div> -->
        </div>
        <footer>
            <div class="footer_left">
                <span class="footer_l">订单扣除:</span>
                <span class="footer_r" id="footercost">0</span><span class="footer_ra">AIB</span>
            </div>
            <div class="footer_right" onclick='pay()'>确认付款</div>
        </footer>
    </div>
    <script type="text/template" id="emalicontenttmpl">
      {{ if(it) { }}
      <span>{{= it.mail}}</span>
      {{ } }}
    </script>
    <script type="text/template" id="pay_infotmpl">
      <div class="wrap_bottom_b_t">
          <span class="wrap_bottom_l">钱包余额:</span>
          <span class="wrap_bottom_r">{{= it.acountcost}}AIB</span>
      </div>
      <div class="wrap_bottom_b_b">
        <div class="top">
          <span class="wrap_bottom_l">使用积分: </span>
          <span class="wrap_bottom_r right">剩余{{= it.points}}积分，可使用<span style="color:#FF4F00" id="infopoint">0</span>积分</span>
        </div>
          <div class="swich">
              <input type="checkbox" value="" name=""/>
              <div class="box">
                  <span></span>
              </div>
          </div>
      </div>
    </script>
    <script type='text/template' id='scrolltmpl'>
    {{ if(it) { }}
      <div class="row">
          <div class="row_l row_l2">卷轴等级:</div>
          <div class="row_r row_r2">{{= it.name }}</div>
      </div>
      <div class="row">
          <div class="row_l">任务数量:</div>
          <div class="row_r">{{= it.totalTask }}道</div>
      </div>
      <div class="row">
          <div class="row_l">每日任务:</div>
          <div class="row_r">{{= it.dailyTask }}道</div>
      </div>
      <div class="row">
          <div class="row_l">每个价值:</div>
          <div class="row_r">{{= it.bonus }}AIB</div>
      </div>
    {{ }else{ }}
      <div class="row">
          <div class="row_l row_l2">卷轴等级:</div>
          <div class="row_r row_r2">未选择卷轴</div>
      </div>
      <div class="row">
          <div class="row_l">任务数量:</div>
          <div class="row_r">0道</div>
      </div>
      <div class="row">
          <div class="row_l">每日任务:</div>
          <div class="row_r">0道</div>
      </div>
      <div class="row">
          <div class="row_l">每个价值:</div>
          <div class="row_r">0AIB</div>
      </div>
    {{ } }}
</script>
</body>
<script type="text/javascript" src="../script/aes.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/zepto.min.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript">
var emalipay;
var rank,cost,acountcost,points,checktog='true';
let user,token,key,enced,costNum;
    apiready = function() {
      user = $api.getStorage('userInfo');
      token = user.token;
      api.addEventListener({
          name: 'myEmali'
      }, function(ret, err) {
          console.log(JSON.stringify(ret.value.fecth));
          let emaliconten = doT.template($api.dom('#emalicontenttmpl').innerHTML);
          emalipay = ret.value;
          $("#emalicontent").html(emaliconten(ret.value.fecth));
      });
      let scrolltmpl = doT.template($api.dom('#scrolltmpl').innerHTML);
      $api.dom('#payScroll').innerHTML = scrolltmpl('');
      api.addEventListener({
          name: 'myEventa'
      }, function(ret, err) {
        rank = ret.value.rank;
        cost = ret.value.cost;
        costNum = ret.value.cost;
        if(points>=cost/5){
          cost = cost/5;
        }else {
          cost= points;
        }
        $api.dom('#infopoint').innerHTML = cost;
        $api.dom('#footercost').innerHTML = costNum - cost;
          let scrolltmpl = doT.template($api.dom('#scrolltmpl').innerHTML);
          $api.dom('#payScroll').innerHTML = scrolltmpl(ret.value);
      });

      getRequest('branch/getBranchInfo','',function(ret){
        if(ret.flag ==true && ret){
         points = ret.data.points;
         getRequest('getAccountBalance','',function(ret){
           if(ret.flag ==true && ret){
             for(var i = 0;i<ret.data.length;i++){
               if(ret.data[i].currency == "AIB"){
                 if(typeof ret.data[i].freezeAmount == 'number' ){
                   acountcost = ret.data[i].amount-ret.data[i].freezeAmount
                 }else {
                   acountcost = ret.data[i].amount;
                 }
               }
             }
             var data={};
             data['points'] = points;
             data['acountcost'] = acountcost;
             let pay_infotmpl = doT.template($api.dom('#pay_infotmpl').innerHTML);
             $api.dom('#pay_info').innerHTML = pay_infotmpl(data);
             (function(select) {
                 var box = document.querySelector(select)
                 var checkbox = box.querySelector("input");
                 box.classList.toggle("swich-on");
                 box.onclick = function() {
                     this.classList.toggle("swich-on");
                     if (checktog=="true") {
                       console.log("选中");
                       $api.dom('#footercost').innerHTML = costNum;
                         checktog = "false";
                     } else {
                       $api.dom('#footercost').innerHTML = costNum - cost;
                       console.log("没有选中");
                         checktog = "true";
                     }
                     console.log(checktog)
                 }
             })(".swich");
           }
         })


        }
      })


    };
    function choiceUser() {
      api.openWin({
          name: 'selectUser_win',
          url: './selectUser_win.html',
      });
    }

    function pay() {
      if(!rank){
        api.toast({ msg: '请先选择卷轴' });
        return;
      }
      if(!emalipay){
        api.toast({ msg: '请先选择用户' });
        return;
      }
        console.log($api.getStorage('password'));
        if($api.getStorage('password')){
          console.log($api.getStorage('password'))
        }else {
          api.confirm({
              title: '提示',
              msg: '未设置资金密码，是否去设置？',
              buttons: ['确定', '取消']
          }, function(ret, err) {
              // var index = ret.buttonIndex;i
              if(ret.buttonIndex=="1"){
                api.openWin({
                    name: 'funds_win',
                    url: './funds_win.html'
                });
              }else {
                api.toast({msg: '未设置资金密码无法支付',});
              }
          });
          return;
        }

      // console.log(JSON.stringify(emalipay.fecth.invitationCode));
        api.openFrame({
            name: 'pwd2',
            url: './pwd2.html',
            rect: {
                x: 0,
                y: 0,
                w: api.winWidth,
                h: api.winHeight,
            },
            // pageParam:{
            //     emalipay:emalipay.fecth.invitationCode
            // },
            bounces: false,
            bgColor: 'rgba(255,255,255,.2)',
        });
    }

    function selectScroll() {
      api.openWin({
          name: 'select_scroll_win',
          url: './select_scroll_win.html',
      });

    }
    function payCallback(pwd){
      // console.log(String(pwd));
          postRequest('getAeskey',{accessToken:token},function (ret) {
            if(ret.flag == true){
              key =ret.data;
              // console.log(key);
              var keyval = CryptoJS.enc.Utf8.parse(key);
              // console.log(keyval);
              var plaintText = String(pwd);
              var iv   = CryptoJS.enc.Latin1.parse('ed16b1f8a9e648d4');
              var encryptedData = CryptoJS.AES.encrypt(plaintText, keyval, {
                  iv:iv,
                  mode: CryptoJS.mode.CBC,
                  padding: CryptoJS.pad.Pkcs7
              });
              enced = CryptoJS.enc.Base64.stringify(encryptedData.ciphertext);
              console.log(enced);

              var param ={
                rank: rank,
                inviteCode:emalipay.fecth.invitationCode,
                points:cost,
                password:enced
              };
              console.log(JSON.stringify(param));
              postRequest('branch/sendGiftScroll',param,function(ret) {
                if(ret.errCode == '0'){
                  comFirm('购买成功');
                }else {
                  // api.toast({ msg: JSON.stringify(ret.errMsg) });
                  comFirm(ret.errMsg);
                }
              })
            }
          })

    }
    function comFirm(msg){
      api.alert({
          title: '提示',
          msg: msg
      }, function(ret, err) {
          // var index = ret.buttonIndex;i
          if(ret.buttonIndex=="1"){
            api.closeToWin({
                name: 'service_center_win'
            });
          }
      });
    }
</script>

</html>
