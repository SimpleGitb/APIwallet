<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>title</title>
      <link rel="stylesheet" type="text/css" href="../css/api.css"/>
      <link rel="stylesheet" type="text/css" href="../css/style.css"/>
      <style>
          body{
            font-size: .14rem;
          }
          .wrap{

          }
          .wrap_head{
            height: .53rem;
            background:#F9F9F9;
            color: #666666;
            padding: .13rem 0 0 .15rem;
          }
          .email{
            font-size: .16rem;
            margin: .1rem 0 0 0;
            color: #2A3145;
          }
          .form_box{
            padding: 0 .15rem;
          }
          footer{
            font-size: .18rem;
            height: .25rem;
            text-align: center;
            margin: .5rem .15rem 0 .15rem;
            padding: .1rem 1.36rem .1rem 1.37rem;
            background: #376AFC;
            color: #fff;
            border-radius: .1rem;
          }
      </style>
  </head>
  <body>
    <div class="wrap">
      <div class="wrap_head">
        <div>当前账号</div>
        <div id="email"></div>
      </div>
      <div class="form_box">
        <div class="input-t">
            <label>验证码</label>
            <input type="tel" placeholder="请输入您的验证码" id="code" style="width:60%">
            <div class="sendCode" id="sendCode" tapmode >发送验证码</div>
        </div>
        <div class="input-t">
            <label>新密码</label>
            <input type="tel" style="-webkit-text-security:disc" placeholder="请设置您的密码" id="pwd">
            <div class="clear" tapmode onClick="fnClearInput(this)"></div>
        </div>
        <div class="input-t">
            <label>设置密码</label>
            <input type="tel" style="-webkit-text-security:disc" placeholder="请设置您的密码" id="pwd2">
            <div class="clear" tapmode onClick="fnClearInput(this)"></div>
        </div>
      </div>
      <footer onclick="changepassword()">确认修改</footer>
    </div>
  </body>
  <script type='text/template' id='emailTmpl'>
    <div class="email">{{=it.name}}</div>
  </script>
  <script type="text/javascript" src="../script/zepto.min.js"></script>
  <script type="text/javascript" src="../script/doT.min.js"></script>
  <script type="text/javascript" src="../script/api.js"></script>
  <script type="text/javascript" src="../script/common.js"></script>
  <script type="text/javascript" src="../script/aes.js"></script>
  <script type="text/javascript" src="../script/gt.js"></script>
  <script type="text/javascript">
      let user,token,key,enced;
      apiready = function(){
        user = $api.getStorage('userInfo');
        token = user.token;
        var emailTmpl = doT.template($api.dom('#emailTmpl').innerHTML);
        $api.dom('#email').innerHTML = emailTmpl(user);
      };
      function changepassword() {
        let list = [$api.text($api.dom('.email')),$api.val($api.byId('code')),$api.val($api.byId('pwd')),$api.val($api.byId('pwd2'))];
        let param = {
          accessToken:token,
          payPassword:list[2],
          code:list[1]
        }
        if(list[1] == ''){
          api.toast({  msg: '请输入验证码',});
          return;
        }
        if(list[2] == ''){
          api.toast({  msg: '请输入密码',});
          return;
        }
        if(list[3] == ''){
          api.toast({  msg: '请输入确认密码',});
          return;
        }
        if(list[2] !== list[3]){
          api.toast({  msg: '俩次输入的密码不一致',});
          return;
        }
        postRequest('getAeskey',{accessToken:token},function (ret) {
          console.log(JSON.stringify(ret))
          if(ret.flag == true){
            key =ret.data;
            console.log(key);
            var keyval = CryptoJS.enc.Utf8.parse(key);
            console.log(keyval);
            var plaintText = list[2];
            var iv   = CryptoJS.enc.Latin1.parse('ed16b1f8a9e648d4');
            var encryptedData = CryptoJS.AES.encrypt(plaintText, keyval, {
                iv:iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            enced = CryptoJS.enc.Base64.stringify(encryptedData.ciphertext);
            console.log(enced);
            postRequest('setPayPassword',{ accessToken:token,
              payPassword:enced,
              code:list[1]},
              function(ret){
              console.log(JSON.stringify(ret));
              if(ret.flag === true){
                $api.setStorage('password', list[2]);
                api.toast({msg: '资金密码设置成功'});
                setTimeout(function(){
                  api.closeWin();
                },1000)
              }else {
                api.toast({msg: ret.errMsg});
              }
            })
          }
        })
      }
      $(function(){
          $('input').focus(function(){
            $(this).parent().siblings().find('.clear').hide();
            $(this).parent().find('.clear').show();
          })
      })

      //获取验证码
      let wait = 60;
      function time(dom){
        if(wait == 0){
          dom.removeClass('readonly');
          dom.text('发送验证码');
          wait = 60;
        }else{
          dom.addClass('readonly');
          dom.text(wait + '重新发送');
          wait--;
          setTimeout(function() {
            time(dom);
          },1000);
        }
      }
    var handler = function (captchaObj) {
      captchaObj.onReady(function () {
        $('#wait').hide();
      }).onSuccess(function () {
        var result = captchaObj.getValidate();
        if(!result){
          return alert('请完成认证');
        }
        if(wait == 60){
          postRequest('sendMsg',{
            geetest_challenge:result.geetest_challenge,
            geetest_validate:result.geetest_validate,
            geetest_seccode:result.geetest_seccode
          },function (ret) {
            if(ret.flag == true){
              api.toast({msg: "发送成功！"});
              time($('#sendCode'));
            }else{
              api.toast({msg: ret.errMsg});
            }
          })
        }
      });
      $('#sendCode').click(function () {
        if(wait == 60){
          captchaObj.verify();
        }
      })
    };
    $.ajax({
      url:'http://36.33.216.16:28080/app-rest/verification?t=' + (new Date()).getTime(),
      type:'post',
      dataType:'json',
      data:{

      },
      success: function (data) {
        initGeetest({
          gt:data.gt,
          challenge:data.challenge,
          offline:!data.success,
          new_captcha:data.new_captcha,
          timeout:'5000',
          product:'bind',
          width:'300px',
          https:true
        },handler);
      }
    })
  </script>
  </html>
